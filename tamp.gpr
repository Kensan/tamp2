--                              -*- Mode: GPR -*-
--  Filename        : tamp.gpr
--  Description     : GNAT make project file for the kernel.
--  Author          : Luke A. Guest
--  Created On      : Thu Jun 14 11:59:53 2012
--  Licence         : See LICENCE in the root directory.
project TAMP is
   type Build_Name is ("debug", "release");
   type Bug_Name   is ("bug", "clean");
   type Board_Name is ("pc", "rpi");
   type Arch_Name  is ("i386", "x86_64", "arm");
   type Bit_Size   is ("32", "64");

   Build : Build_Name := external ("Build");
   Bug   : Bug_Name   := external ("Bug");
   Board : Board_Name := external ("Board");
   Bits  : Bit_Size   := external ("Bits", "32");
   Arch  : Arch_Name  := "i386";
   Out_Dir := "";

   case Board is
      when "pc" =>
         case Bits is
            when "32" =>
               Arch := "i386";
            when "64" =>
               Arch := "x86_64";
         end case;
      when "rpi" =>
         Arch := "arm";
   end case;

   -- TODO: Add in a case statement that adds an arch dir to source.

   case Board is
      when "pc" =>
         for Source_Dirs use ("src", "src/pc");

         Out_Dir := "./out/disk/boot/";
      when "rpi" =>
         for Source_Dirs use ("src", "src/rpi");

         Out_Dir := "./out/";
   end case;

   for Object_Dir use "obj";
   for Exec_Dir use Out_Dir;
   for Main use ("tamp.adb");

   package Builder is
      Basic_Switches :=
        ("-gnat05", "-x", "-a", "-gnatg", "-gnatec=../gnat.adc", "-gnaty-I",
         "-gnaty+d");
      --, "-fstack-check");

      Builder_Build_Switches := ("");
      Builder_Bug_Switches   := ("");
      Builder_Board_Switches := ("");

      for Executable ("tamp.adb") use "tamp-" & Arch & ".elf";

      case Build is
         when "debug" =>
            Builder_Build_Switches := ("-g", "-O0");
         when "release" =>
            Builder_Build_Switches := ("-O2");
      end case;

      case Bug is
         when "bug" =>
            Builder_Bug_Switches := ("-gnatd.n");
         when "clean" =>
            Builder_Bug_Switches := ("");
      end case;

      case Arch is
         when "i386" =>
            Builder_Board_Switches := ("-m32", "-march=i386");

         when "x86_64" =>
            Builder_Board_Switches := ("-m64");

         when "arm" =>
            Builder_Board_Switches :=
              ("-march=armv6zk", "-mfpu=vfp", "-mfloat-abi=hard", "-marm",
                "-mcpu=arm1176jzf-s", "-mtune=arm1176jzf-s");
      end case;

      for Default_Switches ("Ada") use
        Basic_Switches & Builder_Build_Switches &
        Builder_Bug_Switches & Builder_Board_Switches;
   end Builder;

   package Compiler is
      Basic_Switches := ("-ffunction-sections", "-fdata-sections");

      Compiler_Build_Switches := ("");
      Compiler_Bug_Switches   := ("");
      Compiler_Board_Switches := ("");

      case Build is
         when "debug" =>
            Compiler_Build_Switches  := ("-g", "-O0", "-g3", "-ggdb");
         when "release" =>
            Compiler_Build_Switches  := ("-O2");
      end case;

      case Bug is
         when "bug" =>
            Compiler_Bug_Switches  := ("-v");
         when "clean" =>
            Compiler_Bug_Switches  := ("");
      end case;

      case Board is
         when "pc" =>
            Compiler_Board_Switches := ("");
         when "rpi" =>
            Compiler_Board_Switches := ("");
      end case;

      for Default_Switches ("Ada") use
        Basic_Switches & Compiler_Build_Switches & Compiler_Bug_Switches &
        Compiler_Board_Switches;
   end Compiler;

   package Binder is
      for Default_Switches ("Ada") use ("-r");
   end Binder;

   package Linker is
      Basic_Switches :=
        ("-static", "-nostartfiles", "-nodefaultlibs",
         "-T../src/" & Board & "/linker.ld");

      Linker_Build_Switches := ("");
      Linker_Bug_Switches   := ("");
      Linker_Board_Switches := ("");

      case Build is
         when "debug" =>
            Linker_Build_Switches  := ("");
         when "release" =>
            -- To reduce size of final binary, strip out unused sections.
            Linker_Build_Switches  := ("-Wl,--gc-sections");
      end case;

      case Bug is
         when "bug" =>
            Linker_Bug_Switches  := ("-v");
         when "clean" =>
            Linker_Bug_Switches  := ("");
      end case;

      case Board is
         when "pc" =>
            Linker_Board_Switches := ("");
         when "rpi" =>
            Linker_Board_Switches := ("");
      end case;

      for Default_Switches ("Ada") use
        Basic_Switches & Linker_Build_Switches & Linker_Bug_Switches &
        Linker_Board_Switches;
   end Linker;
end TAMP;
